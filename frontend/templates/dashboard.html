{% extends "base.html" %}

{% block title %}Dashboard - Controle de Gastos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up"></i> Dashboard Financeiro</h2>
    <button class="btn btn-outline-primary" onclick="atualizarDashboard()">
        <i class="bi bi-arrow-clockwise"></i> Atualizar
    </button>
</div>

<!-- Cards de Resumo -->
<div class="row mb-4" id="cards-resumo">
    <!-- Cards serão carregados via JavaScript -->
</div>

<!-- Gráficos -->
<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart"></i> Gastos por Categoria</h5>
            </div>
            <div class="card-body">
                <canvas id="chartCategorias" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart"></i> Distribuição de Gastos</h5>
            </div>
            <div class="card-body">
                <canvas id="chartDistribuicao" width="200" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-trend-up"></i> Previsão de Gastos</h5>
            </div>
            <div class="card-body">
                <canvas id="chartPrevisao" width="400" height="200"></canvas>
                <div class="mt-3">
                    <button class="btn btn-info" onclick="gerarPrevisao()">
                        <i class="bi bi-calculator"></i> Gerar Previsão
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> Últimas Transações</h5>
            </div>
            <div class="card-body">
                <div id="ultimas-transacoes">
                    <!-- Últimas transações serão carregadas aqui -->
                </div>
                <div class="text-center mt-3">
                    <a href="{{ url_for('transacoes') }}" class="btn btn-outline-primary btn-sm">
                        Ver Todas as Transações
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let chartCategorias, chartDistribuicao, chartPrevisao;

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function() {
    atualizarDashboard();
});

async function atualizarDashboard() {
    await carregarResumo();
    await carregarGraficoCategorias();
    await carregarUltimasTransacoes();
}

async function carregarResumo() {
    try {
        const response = await fetch('/api/dashboard/resumo');
        const data = await response.json();
        
        const cardsResumo = document.getElementById('cards-resumo');
        cardsResumo.innerHTML = `
            <div class="col-md-4 mb-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-up-circle text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title text-success mt-2">Receitas do Mês</h5>
                        <h3 class="text-success">R$ ${data.receitas_mes.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-down-circle text-danger" style="font-size: 2rem;"></i>
                        <h5 class="card-title text-danger mt-2">Despesas do Mês</h5>
                        <h3 class="text-danger">R$ ${data.despesas_mes.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-${data.saldo_mes >= 0 ? 'primary' : 'warning'}">
                    <div class="card-body text-center">
                        <i class="bi bi-wallet text-${data.saldo_mes >= 0 ? 'primary' : 'warning'}" style="font-size: 2rem;"></i>
                        <h5 class="card-title text-${data.saldo_mes >= 0 ? 'primary' : 'warning'} mt-2">Saldo do Mês</h5>
                        <h3 class="text-${data.saldo_mes >= 0 ? 'primary' : 'warning'}">R$ ${data.saldo_mes.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Erro ao carregar resumo:', error);
    }
}

async function carregarGraficoCategorias() {
    try {
        const response = await fetch('/api/dashboard/gastos-por-categoria');
        const data = await response.json();
        
        // Destruir gráfico anterior se existir
        if (chartCategorias) {
            chartCategorias.destroy();
        }
        
        const ctx = document.getElementById('chartCategorias').getContext('2d');
        chartCategorias = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.categoria),
                datasets: [{
                    label: 'Gastos (R$)',
                    data: data.map(item => item.total),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
        
        // Gráfico de distribuição (pizza)
        if (chartDistribuicao) {
            chartDistribuicao.destroy();
        }
        
        const ctx2 = document.getElementById('chartDistribuicao').getContext('2d');
        chartDistribuicao = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: data.map(item => item.categoria),
                datasets: [{
                    data: data.map(item => item.total),
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40',
                        '#FF6384',
                        '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('Erro ao carregar gráfico de categorias:', error);
    }
}

async function carregarUltimasTransacoes() {
    try {
        const response = await fetch('/api/transacoes');
        const data = await response.json();
        
        const ultimasTransacoes = document.getElementById('ultimas-transacoes');
        const ultimas5 = data.slice(0, 5);
        
        if (ultimas5.length === 0) {
            ultimasTransacoes.innerHTML = '<p class="text-muted">Nenhuma transação encontrada.</p>';
            return;
        }
        
        ultimasTransacoes.innerHTML = ultimas5.map(transacao => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                    <strong>${transacao.descricao}</strong><br>
                    <small class="text-muted">${transacao.data} - ${transacao.categoria ? transacao.categoria.nome : 'Sem categoria'}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-${transacao.tipo === 'receita' ? 'success' : 'danger'}">
                        ${transacao.tipo === 'receita' ? '+' : '-'}R$ ${transacao.valor.toFixed(2)}
                    </span>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Erro ao carregar últimas transações:', error);
    }
}

async function gerarPrevisao() {
    try {
        // Simulação de previsão (será implementada com ML posteriormente)
        const response = await fetch('/api/transacoes');
        const data = await response.json();
        
        // Calcular média dos últimos 3 meses
        const agora = new Date();
        const tresMesesAtras = new Date(agora.getFullYear(), agora.getMonth() - 3, 1);
        
        const despesasRecentes = data
            .filter(t => t.tipo === 'despesa' && new Date(t.data) >= tresMesesAtras)
            .reduce((sum, t) => sum + t.valor, 0);
        
        const mesesComDados = 3;
        const mediaGastos = despesasRecentes / mesesComDados;
        
        // Projeção simples (será melhorada com ML)
        const previsaoProximoMes = mediaGastos * 1.05; // 5% de aumento
        
        if (chartPrevisao) {
            chartPrevisao.destroy();
        }
        
        const ctx = document.getElementById('chartPrevisao').getContext('2d');
        chartPrevisao = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['3 meses atrás', '2 meses atrás', 'Mês passado', 'Este mês', 'Próximo mês (previsão)'],
                datasets: [{
                    label: 'Gastos (R$)',
                    data: [mediaGastos * 0.9, mediaGastos * 0.95, mediaGastos, mediaGastos * 1.02, previsaoProximoMes],
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
        
        // Mostrar alerta com a previsão
        alert(`Previsão de gastos para o próximo mês: R$ ${previsaoProximoMes.toFixed(2)}`);
        
    } catch (error) {
        console.error('Erro ao gerar previsão:', error);
        alert('Erro ao gerar previsão. Tente novamente.');
    }
}
</script>
{% endblock %}