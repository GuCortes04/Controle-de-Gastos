<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Controle de Gastos Pessoais</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .monospace { font-family: monospace; }
    </style>
</head>
<body class="bg-light">
    <script>
    // If user opened the file with Live Server (not via Flask), try to detect a running Flask server
    (async function(){
        try{
            const res = await fetch('http://127.0.0.1:5000/health', {cache: 'no-store'});
            if(res && res.ok){
                // if we're not already on the Flask origin, redirect there
                if(!location.href.startsWith('http://127.0.0.1:5000')){
                    const target = 'http://127.0.0.1:5000' + location.pathname + location.search + location.hash;
                    location.href = target;
                }
            }
        }catch(e){
            // Flask not available at default host/port ‚Äî do nothing
        }
    })();
    </script>
    <div class="container mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-white rounded p-2 mb-3">
            <div class="container-fluid px-0">
                <a class="navbar-brand ms-2" href="#" data-view="home">üí∞ Controle de Gastos</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="mainNav">
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link active" href="#home" data-view="home">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#relatorios" data-view="relatorios">Relat√≥rios</a></li>
                        <li class="nav-item"><a class="nav-link" href="#previsoes" data-view="previsoes">Previs√µes</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div id="view-home">
        <h1 class="text-center">üí∞ Controle de Gastos Pessoais</h1>

        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Resumo Financeiro</h5>
                    <p><strong>Receitas:</strong> <span class="counter" data-value="{{ receitas or 0 }}">{{ receitas | brl }}</span></p>
                    <p><strong>Despesas:</strong> <span class="counter" data-value="{{ despesas or 0 }}">{{ despesas | brl }}</span></p>
                    <p><strong>Saldo:</strong> <span class="counter" data-value="{{ saldo or 0 }}">{{ saldo | brl }}</span></p>
                </div>

                <div class="card p-3 mt-3">
                    <h5>Nova Transa√ß√£o</h5>
                    <form id="newTxForm" method="POST" action="http://127.0.0.1:5000/adicionar">
                        <div class="mb-2">
                            <select name="tipo" class="form-select form-select-sm" required>
                                <option value="Receita">Receita</option>
                                <option value="Despesa">Despesa</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <input type="text" name="categoria" class="form-control form-control-sm" placeholder="Categoria (opcional - deixe vazio para auto)">
                        </div>
                        <div class="mb-2 row">
                            <div class="col-6">
                                <input type="number" name="valor" class="form-control form-control-sm" step="0.01" placeholder="Valor" required>
                            </div>
                            <div class="col-6">
                                <input type="date" name="data" class="form-control form-control-sm" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <input type="text" name="descricao" class="form-control form-control-sm" placeholder="Descri√ß√£o">
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-success btn-sm">Adicionar</button>
                        </div>
                    </form>
                    <!-- Pending transactions (client-side) -->
                    <div class="mt-3" id="pendingSection" style="display:none;">
                        <h6>Transa√ß√µes pendentes</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-2" id="pendingTable">
                                <thead class="table-light">
                                    <tr><th>Tipo</th><th>Categoria</th><th class="text-end">Valor</th><th>Data</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="text-end">
                            <button id="sendAllBtn" class="btn btn-primary btn-sm me-2">Enviar tudo</button>
                            <button id="clearPendingBtn" class="btn btn-outline-secondary btn-sm">Limpar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-3">
                    <h5>Gr√°fico de Despesas Mensais</h5>
                    <div id="graficoContainer" style="min-height:220px;">
                        <canvas id="despesasChart" width="400" height="180"></canvas>
                        <div id="graficoMensagem" class="text-center text-muted mt-2" style="display:none;">Nenhuma despesa para mostrar.</div>
                    </div>
                    <div class="mt-2">
                        <form method="POST" action="/inserir_exemplo" class="d-inline">
                            <button class="btn btn-sm btn-outline-primary">Inserir dados de exemplo</button>
                        </form>
                        <a href="/exportar_csv" class="btn btn-sm btn-outline-success ms-2">Exportar CSV</a>
                        <form method="POST" action="/importar_csv" enctype="multipart/form-data" class="d-inline ms-2">
                            <input type="file" name="file" accept="text/csv" style="display:inline-block;" required>
                            <button class="btn btn-sm btn-outline-secondary" type="submit">Importar CSV</button>
                        </form>
                    </div>
                </div>

                <div class="card p-3 mt-3">
                    <h5>Transa√ß√µes</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Categoria</th>
                                    <th class="text-end">Valor</th>
                                    <th>Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody">
                                <!-- Server-side rendering removed: populate this tbody via client-side JS or leave empty. -->
                            </tbody>
                            <noscript>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Ative JavaScript para visualizar as transa√ß√µes.</td>
                                    </tr>
                                </tbody>
                            </noscript>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

        </div> <!-- /view-home -->

        <!-- Relat√≥rios view -->
        <div id="view-relatorios" style="display:none;">
            <div class="container mt-4">
                <h2>üìä Relat√≥rios</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3 mb-3">
                            <h6>Gastos por Categoria (√∫ltimos meses)</h6>
                            <canvas id="relatoriosChart" style="min-height:200px;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3 mb-3">
                            <h6>Resumo R√°pido</h6>
                            <p><strong>Total Receitas:</strong> <span id="rel_rec" class="monospace">R$ 0,00</span></p>
                            <p><strong>Total Despesas:</strong> <span id="rel_desp" class="monospace">R$ 0,00</span></p>
                            <p><strong>Saldo:</strong> <span id="rel_saldo" class="monospace">R$ 0,00</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Previs√µes view -->
        <div id="view-previsoes" style="display:none;">
            <div class="container mt-4">
                <h2>ü§ñ Previs√µes</h2>
                <div class="card p-3">
                    <p>Previs√µes de gastos com base no hist√≥rico. (Modelo offline/local)</p>
                    <div id="previsoesContent">
                        <p class="text-muted">Nenhuma previs√£o gerada ainda.</p>
                        <button id="gerarPrevisao" class="btn btn-primary btn-sm">Gerar Previs√£o</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-white text-center mt-4 py-3 border-top">
            <div class="container">
                <small>Desenvolvido por Gustavo Cortes</small>
            </div>
        </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // Format number to BRL (R$ 1.234,56)
    function formatBRL(v){
        const n = Number(v) || 0;
        // use Intl.NumberFormat for correct grouping/decimals
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(n);
    }

    function animateCounter(el, to){
        const start = 0;
        const duration = 700; // ms
        const startTime = performance.now();
        function step(now){
            const t = Math.min((now - startTime) / duration, 1);
            // easeOutQuad
            const eased = 1 - (1 - t) * (1 - t);
            const value = start + (to - start) * eased;
            el.textContent = formatBRL(value);
            if(t < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }

    document.addEventListener('DOMContentLoaded', function(){
        // animate all summary counters
        document.querySelectorAll('.counter').forEach(function(el){
            const to = parseFloat(el.getAttribute('data-value')) || 0;
            // animate only if > 0 to make change visible when adding receipts
            animateCounter(el, to);
        });
    });
    </script>
    <script>
    const FLASK_ORIGIN = 'http://127.0.0.1:5000';
    async function carregarGrafico(){
        try{
            const res = await fetch(FLASK_ORIGIN + '/dados_despesas');
            const data = await res.json();
            if(!data || !data.meses || data.meses.length === 0){
                document.getElementById('despesasChart').style.display = 'none';
                document.getElementById('graficoMensagem').style.display = 'block';
                return;
            }
            const ctx = document.getElementById('despesasChart').getContext('2d');
            document.getElementById('despesasChart').style.display = 'block';
            document.getElementById('graficoMensagem').style.display = 'none';
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Despesas (R$)',
                        data: data.valores,
                        backgroundColor: 'rgba(255,99,132,0.2)',
                        borderColor: 'rgba(255,99,132,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }catch(e){
            console.error('Erro ao carregar gr√°fico', e);
            document.getElementById('despesasChart').style.display = 'none';
            document.getElementById('graficoMensagem').style.display = 'block';
            document.getElementById('graficoMensagem').textContent = 'Erro ao carregar dados do gr√°fico.';
        }
    }

    document.addEventListener('DOMContentLoaded', carregarGrafico);
    </script>
        <script>
        // Client-side transactions loader and pending/batch-send logic
        (function(){
            const pending = [];

            function createCell(text, cls){ const td = document.createElement('td'); if(cls) td.className = cls; td.textContent = text; return td; }

            function renderTransactions(list){
                const tbody = document.getElementById('transactionsBody');
                if(!tbody) return;
                tbody.innerHTML = '';
                list.forEach(function(t){
                    const tr = document.createElement('tr');
                    tr.appendChild(createCell(t.tipo));
                    tr.appendChild(createCell(t.categoria));
                    tr.appendChild(createCell(formatBRL(t.valor), 'text-end'));
                    tr.appendChild(createCell(t.data || ''));
                    tr.appendChild(createCell(t.descricao || ''));
                    const tdActions = document.createElement('td');
                    const a = document.createElement('a');
                    a.href = '/excluir/' + (t.id || '');
                    a.className = 'btn btn-danger btn-sm';
                    a.textContent = 'Excluir';
                    a.onclick = function(){ return confirm('Confirma exclus√£o?'); };
                    tdActions.appendChild(a);
                    tr.appendChild(tdActions);
                    tbody.appendChild(tr);
                });
            }

            async function loadTransactions(){
                try{
                    const res = await fetch(FLASK_ORIGIN + '/transacoes_json');
                    const data = await res.json();
                    if(data && data.transacoes){
                        renderTransactions(data.transacoes);
                    }
                }catch(e){
                    console.error('Erro ao carregar transacoes JSON', e);
                }
            }

            function renderPending(){
                const tbody = document.querySelector('#pendingTable tbody');
                const section = document.getElementById('pendingSection');
                tbody.innerHTML = '';
                if(pending.length === 0){ section.style.display = 'none'; return; }
                section.style.display = 'block';
                pending.forEach(function(t, i){
                    const tr = document.createElement('tr');
                    tr.appendChild(createCell(t.tipo));
                    tr.appendChild(createCell(t.categoria));
                    tr.appendChild(createCell(formatBRL(t.valor), 'text-end'));
                    tr.appendChild(createCell(t.data || ''));
                    tr.appendChild(createCell(t.descricao || ''));
                    const td = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-danger';
                    btn.textContent = 'Remover';
                    btn.onclick = function(){ pending.splice(i,1); renderPending(); };
                    td.appendChild(btn);
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                });
            }

            document.addEventListener('DOMContentLoaded', function(){
                // load existing transactions
                loadTransactions();

                const form = document.getElementById('newTxForm');
                if(form){
                    form.addEventListener('submit', function(e){
                        e.preventDefault();
                        const fd = new FormData(form);
                        const tx = {
                            tipo: fd.get('tipo'),
                            categoria: fd.get('categoria') || 'Sem categoria',
                            valor: parseFloat(fd.get('valor')) || 0,
                            data: fd.get('data') || '',
                            descricao: fd.get('descricao') || ''
                        };
                        pending.push(tx);
                        renderPending();
                        form.reset();
                    });
                }

                const sendAllBtn = document.getElementById('sendAllBtn');
                if(sendAllBtn){
                    sendAllBtn.addEventListener('click', async function(){
                        if(pending.length === 0) return;
                        sendAllBtn.disabled = true;
                        for(const tx of pending.slice()){ // copy
                            const fd = new FormData();
                            fd.append('tipo', tx.tipo);
                            fd.append('categoria', tx.categoria);
                            fd.append('valor', tx.valor);
                            fd.append('data', tx.data);
                            fd.append('descricao', tx.descricao);
                            try{
                                await fetch(FLASK_ORIGIN + '/adicionar', { method: 'POST', body: fd, mode: 'cors' });
                            }catch(e){ console.error('Erro ao enviar transacao', e); }
                        }
                        // reload to refresh server state (counters, table)
                        location.reload();
                    });
                }

                const clearBtn = document.getElementById('clearPendingBtn');
                if(clearBtn){ clearBtn.addEventListener('click', function(){ pending.length = 0; renderPending(); }); }
            });
        })();
        </script>
    <script>
    // Simple client-side SPA router
    function showView(view){
        const views = ['home','relatorios','previsoes'];
        views.forEach(v => {
            const el = document.getElementById('view-' + v);
            if(el) el.style.display = (v === view) ? '' : 'none';
            const link = document.querySelector('[data-view="' + v + '"]');
            if(link) link.classList.toggle('active', v === view);
        });
        // when switching to relatorios, update charts and summary
        if(view === 'relatorios') {
            // compute totals
            try{
                const rec = Array.from(document.querySelectorAll('.counter')).reduce((s, el) => s + (parseFloat(el.getAttribute('data-value'))||0), 0);
                // better: calculate from server-loaded transactions if available
                const txs = window._loadedTransactions || [];
                const receitas = txs.filter(t=>t.tipo==='Receita').reduce((s,t)=>s+(t.valor||0),0);
                const despesas = txs.filter(t=>t.tipo==='Despesa').reduce((s,t)=>s+(t.valor||0),0);
                document.getElementById('rel_rec').textContent = formatBRL(receitas);
                document.getElementById('rel_desp').textContent = formatBRL(despesas);
                document.getElementById('rel_saldo').textContent = formatBRL(receitas-despesas);
                // build simple category chart
                const catMap = {};
                txs.filter(t=>t.tipo==='Despesa').forEach(t=>{ const k=t.categoria||'Outros'; catMap[k]=(catMap[k]||0)+t.valor; });
                const labels = Object.keys(catMap);
                const data = labels.map(l=>catMap[l]);
                const ctx = document.getElementById('relatoriosChart').getContext('2d');
                if(window._relChart) window._relChart.destroy();
                window._relChart = new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ data: data, backgroundColor: labels.map((_,i)=>`hsl(${i*60%360} 70% 70%)`) }] }, options: { responsive:true } });
            }catch(e){ console.error(e); }
        }
    }

    // initialize router
    document.addEventListener('DOMContentLoaded', function(){
        // when transactions loaded, store them for reports
        (function wrapLoad(){
            const originalLoad = window.loadTransactions;
            if(typeof originalLoad === 'function'){
                window.loadTransactions = async function(){
                    await originalLoad();
                    try{ const res = await fetch(FLASK_ORIGIN + '/transacoes_json'); const d = await res.json(); window._loadedTransactions = (d && d.transacoes) ? d.transacoes : []; }catch(e){ window._loadedTransactions = window._loadedTransactions||[]; }
                }
            }
        })();

        // links
        document.querySelectorAll('[data-view]').forEach(a=>{
            a.addEventListener('click', function(e){ e.preventDefault(); const v=this.getAttribute('data-view'); location.hash = v; showView(v); });
        });

        // hash routing
        window.addEventListener('hashchange', function(){ const h = location.hash.replace('#','')||'home'; showView(h); });
        const initial = location.hash.replace('#','') || 'home';
        showView(initial);

        // gerar previsao: try backend ML endpoint, otherwise fallback to client-side average
        const btn = document.getElementById('gerarPrevisao');
        if(btn){ btn.addEventListener('click', async function(){
            const container = document.getElementById('previsoesContent');
            container.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div><span>Gerando previs√£o...</span>';
            const txs = window._loadedTransactions || [];
            // try backend endpoints in order
            const endpoints = [FLASK_ORIGIN + '/api/ml/previsao', FLASK_ORIGIN + '/ml/previsao', FLASK_ORIGIN + '/previsao'];
            let result = null;
            for(const ep of endpoints){
                try{
                    const res = await fetch(ep, { method: 'GET', cache: 'no-store' });
                    if(res && res.ok){
                        const data = await res.json();
                        if(data && (data.previsao || data.predicao || data.value || data.valor)){
                            // normalize
                            result = data.previsao || data.predicao || data.value || data.valor;
                            break;
                        }
                        // if API returns structure {predictions: ...}
                        if(data && data.predictions && data.predictions.length){ result = data.predictions[0]; break; }
                    }
                }catch(e){ /* ignore and continue */ }
            }

            if(result === null){
                // fallback: simple average of past despesas
                const despesas = txs.filter(t=>t.tipo==='Despesa').map(t=>Number(t.valor)||0);
                const avg = despesas.length ? (despesas.reduce((s,v)=>s+v,0)/despesas.length) : 0;
                container.innerHTML = `<p>Previs√£o de despesas (fallback): <strong>${formatBRL(avg)}</strong></p>`;
            } else {
                container.innerHTML = `<p>Previs√£o de despesas (modelo): <strong>${formatBRL(Number(result))}</strong></p>`;
            }
        }); }
    });
    </script>
    </body>
</html>
